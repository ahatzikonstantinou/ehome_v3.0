$def with (mqtt_servers, containers, domains, item_types, items, serial_ports, rflink, rflink_items, rflink_item_index, language,showSection)
$var page = "settings" # used in menu.html to hide/show the language dropdown based on page
$var language = language #so that it is available for menu.html base template
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eHome Setup</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script>
        function decodeHtmlEntities(text) {
            var textarea = document.createElement("textarea");
            textarea.innerHTML = text;
            return textarea.value.replace("'", "\"");
        }

        var items = [
                $for item in items:
                    { 
                        id: $(loop.index0), 
                        itemName: "$item['itemName']", 
                        itemMqttServer: $item['itemMqttServer'], 
                        itemContainer: "$item['itemContainer']", 
                        itemType: "$item['itemType']", 
                        publish: "$item['publish']", 
                        subscribe: "$item['subscribe']",
                        filterById: ${ 'true' if item['filterById'] else 'false' },
                        idFilterValue: "$item['idFilterValue']"
                    },
            ];

        var rflink_items = [
            $for ri in rflink_items:
            {
                id: $(loop.index0),
                mqtt_server: "$ri['mqtt_server']",
                name: "$ri['name']",
                mqtt_state_publish_topic: "$ri['mqtt_state_publish_topic']",
                mqtt_command_subscribe_topic: "$ri['mqtt_command_subscribe_topic']",
                commands: [
                    $for c in ri["commands"]:
                    {
                        name: "$c['name']".replace(/&#39;/g,"\""),
                        pulses_exact: [
                            $for e in c['pulses_exact']:
                                "$e",
                        ],
                        pulse_middle: "$s['pulse_middle']"

                    },                
                ],
                states: [
                    $for s in ri["states"]:
                    {
                        name: decodeHtmlEntities("$s['name']"),
                        pulses_exact: [
                            $for e in s['pulses_exact']:
                                "$e",
                        ],
                        pulses_shift:  [
                            $for ps in s['pulses_shift']:
                                "$ps",
                        ],
                        shift_window_size: "$s['shift_window_size']",
                        max_common_substring: "$s['max_common_substring']",
                        use_exact_pulse: "$s['use_exact_pulse']",
                        use_shift_window: "$s['use_shift_window']",
                        use_max_common_substring: "$s['use_max_common_substring']",
                        pulse_middle: "$s['pulse_middle']"
                    },
                ]
            },
        ];
    </script>
</head>
<body>
    <include src="menu.html"></include>
    <button onclick="toggleContent('mqtt_servers', true);toggleContent('containers', false);toggleContent('items', false);toggleContent('rflink', false);">MQTT Servers</button>
    <button onclick="toggleContent('mqtt_servers', false);toggleContent('containers', true);toggleContent('items', false);toggleContent('rflink', false);">Containers</button>
    <button onclick="toggleContent('mqtt_servers', false);toggleContent('containers', false);toggleContent('items', true);toggleContent('rflink', false);">Items</button>
    <button onclick="toggleContent('mqtt_servers', false);toggleContent('containers', false);toggleContent('items', false);toggleContent('rflink', true);">RFLink</button>

    <div class="settings servers" id="mqtt_servers" $("hidden" if showSection != "mqtt" else "")>        
        <h1>MQTT Servers</h1>
        <h2>Add New Server</h2>
        <form id="serverForm" action="/create/mqtt-server" method="post">
            <input type="hidden" id="server_id" name="server_id" value="">
            <div class="form-group">
                <label for="address">Address:</label>
                <input type="text" id="address" name="address" required>
            </div>
            <div class="form-group">
                <label for="port">Port:</label>
                <input type="number" id="port" name="port" required>
            </div>
            <div class="form-group">
                <label for="ws_port">WebSockets Port:</label>
                <input type="number" id="ws_port" name="ws_port" required>
            </div>
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username">
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password">
            </div>
            
            <button id ="addServerBtn" type="submit">Add Server</button>
            <button id ="cancelServerBtn" type="button" hidden onclick="location.reload()">Cancel</button>
        </form>
        
        <h2>Server List</h2>
        <table id="serversTable">
            <thead>
                <tr>
                    <th>Address</th>
                    <th>Port</th>
                    <th>WebSockets Port</th>
                    <th>Username</th>
                    <th>Password</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                $if mqtt_servers:
                    $for server in mqtt_servers:
                        <tr>
                            <td>$server['address']</td>
                            <td>$server['port']</td>
                            <td>$server['ws_port']</td>
                            <td>$server['username']</td>
                            <td>$server['password']</td>
                            <td>
                                <button type="button" onclick="populateMqttServerForm($loop.index)">Update</button>
                                <form action="/delete/mqtt-server/$(loop.index0)" method="post">
                                    <button type="submit" 
                                    $("" if len(list(i for i in items if i['itemMqttServer'] == loop.index0)) == 0 else "disabled")
                                    >Delete</button>
                                </form>
                                <button type="button" onclick="testConnectivity($loop.index0)">Test</button>                        
                            </td>
                        </tr>
                $else:
                    <tr>
                        <td colspan="5">No MQTT servers found.</td>
                    </tr>
            </tbody>
        </table>    
        <script>
            // mqttServer data
            var mqttServers = [
                $for server in mqtt_servers:
                    { id: $(loop.index-1), address: "$server['address']", port: "$server['port']", username: "$(server['username'] if server['username'] is not None else "null" )", password: "$(server['password'] if server['password'] is not None else "null" )"},
            ];
            function populateMqttServerForm(index) {
                var server = document.getElementById("serversTable").rows[index].cells;
                document.getElementById("address").value = server[0].innerText;
                document.getElementById("port").value = server[1].innerText;
                document.getElementById("ws_port").value = server[2].innerText;
                document.getElementById("username").value = server[3].innerText;
                document.getElementById("password").value = server[4].innerText;
                document.getElementById("server_id").value = index;
                document.getElementById("serverForm").action = "/update/mqtt-server/" + (index-1);
                document.getElementById("addServerBtn").innerText = "Update Server";
                document.getElementById("cancelServerBtn").hidden = false;
            }

            function testConnectivity(index) {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        // document.getElementById("testModal").style.display = "block";
                        // document.getElementById("testModalContent").innerHTML = this.responseText;
                        alert("Connectivity test returned:" + this.responseText);
                    }
                };
                xhttp.open("POST", "/test/mqtt-server/" + index, true);
                xhttp.send();
            }
        </script>
    </div>

    <div class="settings containers" id="containers" $("hidden" if showSection != "containers" else "")>
        <h1>Containers</h1>
        <h2>Create Container</h2>
        <form id="containerForm" action="/create/container" method="post">
            <div class="form-group">
                <label for="containerName">Container Name:</label>
                <input type="text" id="containerName" name="containerName" required>
            </div>
            <div class="form-group">
                <label for="parentContainer">Parent Container:</label>
                <select id="parentContainer" name="parentContainer">
                    <option value="">Select Parent Container</option>
                    <!-- Options will be dynamically generated here -->
                </select>
            </div>        
            <button id="createContainerBtn" type="submit">Create Container</button>
            <button id ="cancelContainerBtn" type="button" hidden onclick="location.reload()">Cancel</button>
        </form>

        <h2 hidden>Containers</h2>
            <table id="containersTable" hidden>
                <thead>
                    <tr>
                        <th>GUID</th>
                        <th>Name</th>
                        <th>MQTT Server</th>
                        <th>Parent</th>
                    </tr>
                </thead>
                <tbody>
                    $if containers:
                        $for container in containers:
                            <tr>
                                <td>$container['guid']</td>
                                <td>$container['containerName']</td>
                                <td>$container['parentContainer']</td>
                                <td>
                                    <button type="button" onclick="populateContainerForm($loop.index-1)">Update</button>
                                    <form action="/delete/container/$(loop.index-1)" method="post">
                                        <button type="submit">Delete</button>
                                    </form>
                                </td>
                            </tr>
                    $else:
                        <tr>
                            <td colspan="5">No containers found.</td>
                        </tr>
                </tbody>
            </table>  

            <!-- Container tree -->
            <div class="container-tree">
                <ul id="containerTree">
                    <!-- Tree structure will be dynamically generated here -->
                </ul>
            </div>

        <!-- Script to populate container elements -->
        <script>
            // Container data
            var containers = [
                // { id: 1, name: "Container 1", parentContainer: null },
                // { id: 2, name: "Container 2", parentContainer: null },
                // { id: 3, name: "Container 1.1", parentContainer: 1 },
                // { id: 4, name: "Container 1.2", parentContainer: 1 },
                // { id: 5, name: "Container 2.1", parentContainer: 2 },
                // { id: 6, name: "Container 2.1.1", parentContainer: 5 }
                $for container in containers:
                    { id: $(loop.index-1), containerName: "$container['containerName']", parentContainer: "$(container['parentContainer'] if container['parentContainer'] is not None else "null" )", guid: "$container['guid']" },
            ];
            containers.forEach(function(c){
                if( c.parentContainer == "null" )
                {
                    c.parentContainer = null;
                }
            })

            // Function to generate nested list structure for container tree
            function generateContainerTree(containers, parentId) {
                var tree = "";
                containers.forEach(function(container) {
                    if (container.parentContainer === parentId) 
                    {
                        // disable the delete button for the container if it has items but no parent
                        // because if deleted, the items will have no container to move  to
                        let container_items = items.filter(function(i){ return i.itemContainer == container.guid;});
                        var disable_delete = container_items.length > 0 && container.parentContainer == null ? "disabled" : "";
                        // console.log("Container's " + container.containerName + "{" + container.guid + "} delete is '" + disable_delete + "' because container_items: ", container_items.length);
                        tree += "<li><div>" + container.containerName +
                            "<button class=\"treeItem\" type=\"button\" onclick=\"populateContainerForm("+ container.id +")\">Update</button>"+
                                    "<form class=\"treeItem\" action=\"/delete/container/"+ container.id +"\" method=\"post\">" +
                                        "<button class=\"treeItem\" type=\"submit\"" + disable_delete + ">Delete</button>" +
                                    "</form></div>";

                        var children = generateContainerTree(containers, container.guid);
                        if (children) {
                            tree += "<ul>" + children + "</ul>";
                        }
                        tree += "</li>";
                    }
                });
                return tree;
            }

            // Populate the container tree
            var containerTree = document.getElementById("containerTree");
            containerTree.innerHTML += generateContainerTree(containers, null);

            function populateContainerForm(index) 
            {
                console.log(index,containers[index]);
                var id = index;
                console.log("parentContainer: " + containers[id].parentContainer);
                document.getElementById("containerName").value = containers[id].containerName;
                document.getElementById("parentContainer").value = containers[id].parentContainer != null ? containers[id].parentContainer : "" ;
                document.getElementById("containerForm").action = "/update/container/" + id;
                document.getElementById("createContainerBtn").innerText = "Update Container";
                document.getElementById("cancelContainerBtn").hidden = false;
            }        

            // Function to generate options for dropdown recursively
            function generateContainerOptions(containers, parentGuid, level, excludeContainerId) {
                console.log("Generating container options for parentGuid:" + parentGuid +", excludeContainerId:" + excludeContainerId);
                var options = "";
                containers.forEach(function(container) {
                    if (container.parentContainer === parentGuid && 
                        container.id !== excludeContainerId) 
                    {
                        console.log("   adding container id:" + container.id );
                        options += "<option value='" + container.guid + "'>" + "&nbsp;&nbsp;&nbsp;&nbsp;".repeat(level) + container.containerName + "</option>";
                        options += generateContainerOptions(containers, container.guid, level + 1, excludeContainerId);
                    }
                });
                return options;
            }

            // Populate the dropdown with container options
            var parentContainerDropdown = document.getElementById("parentContainer");
            parentContainerDropdown.innerHTML += generateContainerOptions(containers, null, 0);            
        </script>
    </div>

    <div class="settings items" id="items" $("hidden" if showSection != "items" else "")> 
        <h1>Items</h1>
        <h2>Create Item</h2>
        <form id="itemForm" action="/create/item" method="post">
            <div class="form-group">
                <label for="itemMqttServer">MQTT Server:</label>
                <select id="itemMqttServer" name="itemMqttServer" required">
                    <option value="">Select MQTT Server</option>
                    <!-- Options will be dynamically generated here -->
                </select>
            </div>
            <div class="form-group">
                <label for="itemContainer">Container:</label>
                <select id="itemContainer" name="itemContainer" required>
                    <option value="">Select Container</option>
                    <!-- Options will be dynamically generated here -->
                </select>
            </div> 
            <div class="form-group">
                <label for="itemName">Item Name:</label>
                <input type="text" id="itemName" name="itemName" required>
            </div>
            <div class="form-group">
                <label for="itemType">Item type:</label>
                <select id="itemType" name="itemType" required>
                    <option value="">Select item type</option>
                    <!-- Options will be dynamically generated here -->
                </select>
            </div>
            <div class="form-group">
                <label for="publish">MQTT Publish Topic:</label>
                <input type="text" id="publish" name="publish" required>
            </div>
            <div class="form-group">
                <label for="subscribe">MQTT Subscribe Topic:</label>
                <input type="text" id="subscribe" name="subscribe">
            </div>
            
            <div class="form-group">
                <label for="filterById">Filter by Id:</label>
                <div style="display: flex;">
                    <input type="checkbox" id="filterById" name="filterById">
                    <input type="text" id="idFilterValue" name="idFilterValue">
                </div>
            </div>
            
            <button id="createItemBtn" type="submit">Create Item</button>
            <button id ="cancelItemBtn" type="button" hidden onclick="location.reload()">Cancel</button>
        </form>

        <table id="itemsTable">
            <thead>
                <tr>
                    <th>MQTT Server</th>
                    <th>Container</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>MQTT Publish</th>
                    <th>MQTT Subscribe</th>
                </tr>
            </thead>
            <tbody>
                $if items:
                    $for item in items:
                        <tr>
                            <td>$(mqtt_servers[int(item['itemMqttServer'])]['address'] + ":")$mqtt_servers[int(item['itemMqttServer'])]['port']</td>
                            $code:
                                def getParent(containerGuid, delimit):
                                    if not containerGuid:
                                        return ""
                                    containerList = list(c for c in containers if c['guid'] == containerGuid)
                                    if len(containerList) == 0:
                                        return "Container '" + containerGuid + "' not Found"
                                    container = containerList[0]
                                    if container['parentContainer']:
                                        return getParent(container['parentContainer'], delimit) + delimit + container['containerName']
                                    else:
                                        return container['containerName']
                            <td>$getParent(item['itemContainer'], " - ")</td>
                            <td>$item['itemName']</td>
                            <td>
                                $(t['description'] for t in item_types if t['id'] == item['itemType'])
                            </td>
                            <td>$item['publish']</td>
                            <td>$item['subscribe']</td>
                            <td>
                                <button type="button" onclick="populateItemForm($(loop.index0))">Update</button>
                                <form action="/delete/item/$(loop.index0)" method="post">
                                    <button type="submit">Delete</button>
                                </form>
                            </td>
                        </tr>
                $else:
                    <tr>
                        <td colspan="5">No items found.</td>
                    </tr>
            </tbody>
        </table>  

        <!-- Items tree -->
        <div class="item-tree">
            <ul id="itemTree">
                <!-- Tree structure will be dynamically generated here -->
            </ul>
        </div>

        <script>
            // Function to generate nested list structure for item tree
            function generateItemTree(containers, parentId) {
                var tree = "";
                containers.forEach(function(container) {
                    if (container.parentContainer === parentId) {
                        tree += "<li>" + container.containerName;
                        var container_items = items.filter(function(item){
                            // console.log("checking itemContainer: " + item.itemContainer + " against container: " + container.guid);
                            return item.itemContainer == container.guid;
                        });
                        // console.log("for container " + container.guid + " container_items: ", container_items);
                        if(container_items)
                        {
                            tree += "<ul>" + container_items.map(function(item){
                                return "<li><div>" + item.itemName +
                                "<button class=\"treeItem\" type=\"button\" onclick=\"populateItemForm("+ item.id +")\">Update</button>"+
                                "<form class=\"treeItem\" action=\"/delete/item/"+ item.id +"\" method=\"post\">" +
                                    "<button class=\"treeItem\" type=\"submit\">Delete</button>" +
                                "</form></div></li>" ;
                            }).join("")
                            + "</ul>";
                            
                        }
                        var children = generateItemTree(containers, container.guid);
                        if (children) {
                            tree += "<ul>" + children + "</ul>";
                        }
                        tree += "</li>";
                    }
                });
                return tree;
            }

            // Populate the item tree
            var itemTree = document.getElementById("itemTree");
            itemTree.innerHTML += generateItemTree(containers, null);

            function populateItemForm(index) 
            {
                console.log(index,items[index]);
                var id = index;
                console.log("itemContainer: " + items[id].itemContainer);
                document.getElementById("itemName").value = items[id].itemName;
                document.getElementById("itemMqttServer").value = items[id].itemMqttServer;
                document.getElementById("itemContainer").value = items[id].itemContainer;
                document.getElementById("itemType").value = items[id].itemType;
                document.getElementById("publish").value = items[id].publish;
                document.getElementById("subscribe").value = items[id].subscribe;
                document.getElementById("idFilterValue").value = items[id].idFilterValue;
                console.log("filterById: " + items[id].filterById);
                document.getElementById("filterById").checked = items[id].filterById === true;
                document.getElementById("itemForm").action = "/update/item/" + id;
                document.getElementById("createItemBtn").innerText = "Update Item";
                document.getElementById("cancelItemBtn").hidden = false;
            }        

             // Function to generate MQTT server options
             function generateMqttServerOptions() {
                var options = "";
                $for server in mqtt_servers:
                    options += "<option value='$(loop.index0)'>$server['address']:$server['port']</option>";
                
                return options;
            }
            // Populate the MQTT server dropdown
            var mqttServerDropdown = document.getElementById("itemMqttServer");
            mqttServerDropdown.innerHTML += generateMqttServerOptions();            

            function generateItemTypesOptions()
            {
                var options = "";
                $for item_type in item_types:
                    options += "<option value='$item_type['id']'>$item_type['description']</option>";
                
                return options;
            }
            // Populate the type dropdown
            var itemTypeDropdown = document.getElementById("itemType");
            itemTypeDropdown.innerHTML += generateItemTypesOptions();

            var parentContainerDropdown = document.getElementById("itemContainer");
            // Populate the dropdown with container options
            parentContainerDropdown.innerHTML = 
                    "<option value=\"\">Select Container</option>" +
                    generateItemContainerOptions(containers, null, null);

            // Function to generate options for dropdown recursively
            function generateItemContainerOptions(containers, parentGuid, level) {
                console.log("Generating item container options for parentGuid:" + parentGuid);
                var options = "";
                containers.forEach(function(container) {
                    if (container.parentContainer === parentGuid) 
                    {
                        console.log("   adding container id:" + container.id );
                        options += "<option value='" + container.guid + "'>" + "&nbsp;&nbsp;&nbsp;&nbsp;".repeat(level) + container.containerName + "</option>";
                        options += generateItemContainerOptions(containers, container.guid, level + 1);
                    }
                });
                return options;
            }

        </script>
    </div>

    <div class="settings rflink" id="rflink" $("hidden" if not showSection.startswith("rflink") else "")>
        <div>
            <button onclick="toggleContent('rflink_items', true);toggleContent('rflink_pulses', false)">Items</button>
            <button onclick="toggleContent('rflink_items', false);toggleContent('rflink_pulses', true)">Pulses</button>
        </div>
        <div id="rflink_items" $("hidden" if not showSection.endswith("item") else "")>
            <h4>RFLink Items</h4>            
            <form id="rflink_item_form" action="/rflink_item/create" method="post">
                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" id="rflink_item_name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="rflink_item_mqtt_server">MQTT Server:</label>
                    <select id="rflink_item_mqtt_server" name="mqtt_server" required">
                        $for server in mqtt_servers:
                            <option value='$(loop.index0)'>$server['address']:$server['port']</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Mqtt State Publish Topic:</label>
                    <input type="text" id="rflink_item_mqtt_state_publish_topic" name="mqtt_state_publish_topic">
                </div>
                <div class="form-group">
                    <label>Mqtt Command Subscribe Topic:</label>
                    <input type="text" id="rflink_item_mqtt_command_subscribe_topic" name="mqtt_command_subscribe_topic">
                </div>                
                <button id="createRflinkItemBtn" type="submit">Create Item</button>
                <button id="fromRflinkItemBtn" onclick="populateRflinkItemFromItem(event)">From</button>
                <select id="itemsToCopyRFlinkFrom">
                $if items:
                    $for item in items:
                        $code:
                            def getParent(containerGuid, delimit):
                                if not containerGuid:
                                    return ""
                                containerList = list(c for c in containers if c['guid'] == containerGuid)
                                if len(containerList) == 0:
                                    return "Container '" + containerGuid + "' not Found"
                                container = containerList[0]
                                if container['parentContainer']:
                                    return getParent(container['parentContainer'], delimit) + delimit + container['containerName']
                                else:
                                    return container['containerName']
                        <option value="$loop.index0">$getParent(item['itemContainer'], " - ") - $item['itemName']</option>
                $else:
                    <option value="">No items found.</option>
                </select>

                <button id ="cancelRflinkItemBtn" type="button" hidden onclick="location.reload()">Cancel</button>
            </form>

            <div id="rflink-items-commands-states" class="commands-states" hidden>
                <form id="rflink_item_command_form" action="/rflink_item/command/create" method="post">
                    <div class="form-group">
                        <label>Commands:</label>
                        <div class="commands" id="rflink-commands"></div>
                    </div>
                    <div class="form-group add">
                        <input type="text" id="rflink_item_command" name="rflink_item_command" size="20" required>
                        <button id="rflink-commands-add-btn">Add</button>
                        <button id="rflink-commands-update-btn" hidden>Update</button>
                        <button id="rflink-commands-cancel-btn" hidden>Cancel</button>
                    </div>
                </form>
                <note>Note that states are case sensitive. Curly brackets and a timestamp will be automatically added. So when a state is detected the relevant mqtt message that will be transmitted will be <code>{#state#, "timestamp": "1972-01-01 23:18:59"</code>. </note>
                <form id="rflink_item_state_form" action="/rflink_item/state/create" method="post">
                    <div class="form-group">
                        <label>States:</label>
                        <div class="states" id="rflink-states"></div>
                    </div>
                    <div class="form-group add">
                        <input type="text" id="rflink_item_state" name="rflink_item_state" required>
                        <button id="rflink-states-add-btn">Add</button>
                        <button  id="rflink-states-update-btn" hidden>Update</button>
                        <button id="rflink-states-cancel-btn" hidden>Cancel</button>
                    </div>
                </form>
            </div>
            <table id="rflink_item_table">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">MQTT Server</th>
                        <th onclick="sortTable(1)">Name</th>
                        <th hidden>Mqtt State Publish Topic</th>
                        <th hidden>Mqtt Command Subscribe Topic</th>
                        <th hidden>Commands</th>
                        <th hidden>States</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    $for item in rflink_items:                        
                        <tr>
                            <td>$(mqtt_servers[int(item['mqtt_server'])]['address'] + ":")$mqtt_servers[int(item['mqtt_server'])]['port']</td>
                            <td>$item["name"]</td>
                            <td hidden>${item["mqtt_state_publish_topic"]}</td>
                            <td hidden>${item["mqtt_command_subscribe_topic"]}</td>
                            <td hidden>${', '.join([list(c.keys())[0] for c in item["commands"]])}</td>
                            <td hidden>${', '.join([s["name"] for s in item["states"]])}</td>
                            <td>
                                <button onclick="populateRflinkItemForm(${loop.index0})">Update</button>
                                <form action="/rflink_item/delete/$(loop.index0)" method="post">
                                    <button>Delete</button>
                                </form>
                            </td>
                        </tr>
                </tbody>
            </table>        
        
            <script>
                // Select the necessary elements
                var cancelRflinkItemButton = document.getElementById('cancelRflinkItemBtn');
                var addCommandsButton = document.getElementById('rflink-commands-add-btn');
                var addStatesButton = document.getElementById('rflink-states-add-btn');
                var updateCommandsButton = document.getElementById('rflink-commands-update-btn');
                var updateStatesButton = document.getElementById('rflink-states-update-btn');
                var cancelCommandsButton = document.getElementById('rflink-commands-cancel-btn');
                var cancelStatesButton = document.getElementById('rflink-states-cancel-btn');
                var inputCommands = document.getElementById('rflink_item_command');
                var inputStates = document.getElementById('rflink_item_state');
                var commandsDiv = document.getElementById('rflink-commands');
                var statesDiv = document.getElementById('rflink-states');
                var itemsToCopyRFlinkFromSelect = document.getElementById('itemsToCopyRFlinkFrom');

                function getParent(containerGuid, delimit) {
                    if (!containerGuid) {
                        return "";
                    }
                    
                    var containerList = containers.filter(function(c) {
                        return c.guid === containerGuid;
                    });
                    
                    if (containerList.length === 0) {
                        return "Container '" + containerGuid + "' not Found";
                    }
                    
                    var container = containerList[0];
                    
                    if (container.parentContainer) {
                        return getParent(container.parentContainer, delimit) + delimit + container.containerName;
                    } else {
                        return container.containerName;
                    }
                }

                function populateRflinkItemFromItem(event)
                {
                    // Prevent form submission
                    event.preventDefault();

                    if(itemsToCopyRFlinkFromSelect.value == "")
                    {
                        return;
                    }
                    let item = items[Number(itemsToCopyRFlinkFromSelect.value)];
                    console.log("Will populate rflink item from: ", item);

                    document.getElementById("rflink_item_mqtt_server").value = item.itemMqttServer;
                    document.getElementById("rflink_item_name").value = getParent(item.itemContainer, " - ") + " - " + item.itemName;
                    document.getElementById("rflink_item_mqtt_state_publish_topic").value = item.publish;
                    document.getElementById("rflink_item_mqtt_command_subscribe_topic").value = item.subscribe;
                }

                // Function to create a span with "x" button
                function createSpan(text, type, id, item_id) {
                    var span = document.createElement('span');
                    span.setAttribute("data-type", type);
                    span.setAttribute("data-id", id);
                    span.setAttribute("data-item_id", item_id);
                    if(type == 'command')
                    {
                        span.textContent = text.slice(1, -1);
                    }
                    else if(type == 'state')
                    {
                        span.textContent = text;
                    }
                    var closeButton = document.createElement('button');
                    // closeButton.innerHTML = "&times;";
                    closeButton.className = 'mdi mdi-close close';
                    closeButton.addEventListener('click', function() {
                        if(type == 'command')
                        {
                            let form = document.getElementById('rflink_item_command_form');
                            form.action = "/rflink_item/" + item_id + "/command/" + id + "/delete";
                            form.submit();
                        }
                        else if(type == 'state')
                        {
                            let form = document.getElementById('rflink_item_state_form');
                            form.action = "/rflink_item/" + item_id + "/state/" + id + "/delete";
                            form.submit();
                        }
                    });

                    span.appendChild(closeButton);
                    return span;
                }                

                updateCommandsButton.addEventListener('click', function(){
                    let form = document.getElementById('rflink_item_command_form');
                    // console.log("form action: " + form.action);
                    form.submit();
                });

                updateStatesButton.addEventListener('click', function(){
                    let form = document.getElementById('rflink_item_state_form');
                    // console.log("form action: " + form.action);
                    form.submit();
                });

                cancelCommandsButton.addEventListener('click', function(){
                    inputCommands.value = '';
                    addCommandsButton.style.display = 'inline-block';
                    updateCommandsButton.style.display = 'none';
                    this.style.display = 'none';
                });
                
                cancelStatesButton.addEventListener('click', function(){
                    inputStates.value = '';
                    addStatesButton.style.display = 'inline-block';
                    updateStatesButton.style.display = 'none';
                    this.style.display = 'none';
                });

                // Function to handle clicking on a span
                commandsDiv.addEventListener('click', function(event) {
                    var target = event.target;
                    if (target.tagName === 'SPAN') {
                        inputCommands.value = target.textContent; // Copy the contents of the span into the input
                        addCommandsButton.style.display = 'none'; // Hide the add button
                        updateCommandsButton.style.display = 'inline-block'; // Display the update button
                        cancelCommandsButton.style.display = 'inline-block'; // Display the update button
                        let form = document.getElementById('rflink_item_command_form');
                        form.action = "/rflink_item/" + target.getAttribute("data-item_id") + "/command/" + target.getAttribute("data-id") + "/update";
                        // console.log("form action: " + form.action);
                    }
                });

                statesDiv.addEventListener('click', function(event) {
                    var target = event.target;
                    if (target.tagName === 'SPAN') {
                        inputStates.value = target.textContent;
                        addStatesButton.style.display = 'none'; // Hide the add button
                        updateStatesButton.style.display = 'inline-block'; // Display the update button
                        cancelStatesButton.style.display = 'inline-block'; // Display the update button
                        type = target.getAttribute("data-type");
                        let form = document.getElementById('rflink_item_state_form');
                        form.action = "/rflink_item/" + target.getAttribute("data-item_id") + "/state/" + target.getAttribute("data-id") + "/update";
                        // console.log("form action: " + form.action);                        
                    }
                });

                function populateRflinkItemForm(index) 
                {
                    console.log(index,rflink_items[index]);
                    var id = index;
                    document.getElementById("rflink_item_mqtt_server").value = rflink_items[index].mqtt_server;
                    document.getElementById("rflink_item_name").value = rflink_items[index].name;
                    document.getElementById("rflink_item_mqtt_state_publish_topic").value = rflink_items[index].mqtt_state_publish_topic;
                    document.getElementById("rflink_item_mqtt_command_subscribe_topic").value = rflink_items[index].mqtt_command_subscribe_topic;
                    document.getElementById("rflink_item_form").action = "/rflink_item/update/" + id;
                    document.getElementById("rflink_item_command_form").action = "/rflink_item/" + id + "/command/create";
                    document.getElementById("rflink_item_state_form").action = "/rflink_item/" + id + "/state/create";
                    document.getElementById("createRflinkItemBtn").innerText = "Update Item";
                    document.getElementById("cancelRflinkItemBtn").hidden = false;
                    document.getElementById("rflink-items-commands-states").hidden = false;
                    commandsDiv.innerText = '';
                    statesDiv.innerText = '';
                    rflink_items[index].commands.forEach((c,i) => {commandsDiv.appendChild(createSpan(c.name, "command", i, index));});
                    rflink_items[index].states.forEach((s,i) => {statesDiv.appendChild(createSpan(s.name, "state", i, index));});
                }      
        
                function sortTable(n) {
                    var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
                    table = document.getElementById("rflink_item_table");
                    switching = true;
                    dir = "asc"; 
                    while (switching) {
                        switching = false;
                        rows = table.rows;
                        for (i = 1; i < (rows.length - 1); i++) {
                            shouldSwitch = false;
                            x = rows[i].getElementsByTagName("td")[n];
                            y = rows[i + 1].getElementsByTagName("td")[n];
                            if (dir == "asc") {
                                if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                                    shouldSwitch= true;
                                    break;
                                }
                            } else if (dir == "desc") {
                                if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                                    shouldSwitch= true;
                                    break;
                                }
                            }
                        }
                        if (shouldSwitch) {
                            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                            switching = true;
                            switchcount ++;      
                        } else {
                            if (switchcount == 0 && dir == "asc") {
                                dir = "desc";
                                switching = true;
                            }
                        }
                    }
                }
           
                cancelRflinkItemButton.addEventListener("click", function() {
                    // Check if the query string contains rflink_item_index
                    if (window.location.search.indexOf('rflink_item_index=') !== -1) {
                        // Parse the existing query string
                        var queryParams = new URLSearchParams(window.location.search);

                        // Remove the rflink_item_index parameter
                        queryParams.delete('rflink_item_index');

                        // Construct the new URL with the updated query string
                        var newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?' + queryParams.toString();

                        // Replace the current URL with the new one
                        window.history.replaceState({}, document.title, newUrl);

                        // Reload the window
                        window.location.reload();
                    }
                });

                $if rflink_item_index:
                populateRflinkItemForm($rflink_item_index)
           </script>
        </div>
        <div id="rflink_pulses" $("hidden" if not showSection.endswith("pulses") else "")>
            <H4>Pulses ($("Connected" if rflink["connected"] else "Disconnected"))</H4>
            <p>$rflink["error"]</p>
            <form id="rfLinkConnectForm" action="/rflink/activate" method="post">
                <div class="form-group" style="display: flex;align-items: center;">
                        <label for="serial_port">Serial Port:</label>
                        <select id="serial_port" name="serial_port" required>
                        $for s in serial_ports:
                            <option value="$s">$s</option>
                        </select>
                        <label for="activateRFLink">Activate</label>
                        <input type="checkbox" id="activateRFLink" ${"checked" if rflink["connected"] else ""}>                    
                        <label for="debugRFLink">Debug</label>
                        <input type="checkbox" id="debugRFLink" ${"checked" if rflink["debug"] else ""}>                    
                </div>
            </form>

            <div class="messages">
                <textarea id="rflink_messages" rows="10" style="
                    width: 100%; /* Take all available width */
                    height: calc(1.5em * 10); /* 10 lines of height */
                    resize: vertical; /* Allow vertical resizing */
                    overflow-y: scroll; /* Show vertical scrollbar when needed */
                    box-sizing: border-box; /* Include padding and border in the width */
                    padding: 5px; /* Add padding to the textarea */
                "></textarea>
                <div id="modalTestResults" class="modal">
                    <!-- Modal content -->
                    <div class="modal-content">
                    <span><strong>Test Results</strong></span>
                    <span class="close">&times;</span>
                      <textarea id="rflink_test_results" style="
                        width: 100%; /* Take all available width */
                        height: calc(1.5em * 10); /* 10 lines of height */
                        resize: vertical; /* Allow vertical resizing */
                        overflow-y: scroll; /* Show vertical scrollbar when needed */
                        box-sizing: border-box; /* Include padding and border in the width */
                        padding: 5px; /* Add padding to the textarea */
                    "></textarea>
                    </div>
                  
                  </div>
                <div class="buttons">
                    <button id="rflinkConnectBtn" onclick="connectRFLink()" $("disabled" if not rflink["connected"] else "")>Connect</button>
                    <button id="rflinkDisconnectBtn" onclick="disconnectRFLink()" style="display:none;">Disconnect</button>
                    <button id="rflinkTestBtn" onclick="testRFLink()">Test</button>
                    <button id="rflinkClearBtn" onclick="clearRFLinkTextarea()">Clear Messages</button>
                </div>
            </div>
            <div class="processing">
                <!-- <form id="rflink-item-state-form" action="rflink/state/add" method="post"> -->
                    <hr>
                    <div class="controls">
                        <label for="rflink_item_state_select">States:</label>
                        <select id="rflink_item_state_select" name="rflink_item" required>
                            $for ri in rflink_items:
                                $ i = loop.index0
                                $for s in ri["states"]:
                                    <option value="$i,$(loop.index0),state">$(ri["name"])&nbsp;-&nbsp;state&nbsp;-&nbsp;$(s["name"])</option>
                        </select>
                    </div>
                    <div class="controls" id="rflink_pulse_middle_controls" hidden>
                        <label for="rflink_pulse_middle">Pulse middle:</label>
                        <input type="number" min="0" name="pulse_middle" id="rflink_pulse_middle">
                    </div>
                    <button id="rflink_pulse_add_exact_btn" onclick="rflinkAddExactPulse()">Add Exact</button>
                    <button id="rflink_pulse_add_shift_btn" onclick="rflinkAddShiftPulse()" hidden>Add Shift</button>
                <!-- </form> -->
                <div id="rflink-item-command" hidden>
                    <h4>Exact Comparison Pulse Sequences</h4>
                    <table id="rflink-item-command-exact-pulse">
                        <thead>
                            <th class="count">Count</th>
                            <th>Sequence</th>
                            <th class="action"></th>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <div id="rflink-item-state" hidden>
                    <h4>
                        <input type="checkbox" id="rflink-item-state-use-exact-pulse">
                        Exact Comparison Pulse Sequences
                    </h4>
                    <table id="rflink-item-state-exact-pulse">
                        <thead>
                            <th class="count">Count</th>
                            <th>Sequence</th>
                            <th class="action"></th>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <h4>Shift Comparison Pulse Sequences</h4>
                    <table id="rflink-item-state-shift-pulse">
                        <thead>
                            <th class="count">Count</th>
                            <th>Sequence</th>
                            <th class="action"></th>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <h4><input type="checkbox" id="rflink_item_use_shift_window">Shift window
                        <div class="controls">
                            <label for="rflink_shift_window_size">size:</label>
                            <input type="number" min="1" id="rflink_shift_window_size" name="rflink_shift_window_size" required value="0">                    
                        </div>
                    </h4>
                    <h4><input type="checkbox" id="use_rflink_max_common_substring">Max common substring
                        <textarea id="rflink_max_common_substring" name="rflink_max_common_substring"  readonly></textarea>
                    </h4>
                </div>
            </div>
                <script>
                    const rflink_messages = document.getElementById('rflink_messages');
                    const rflinkItemSelect = document.getElementById('rflink_item_state_select');
                    const rflinkItemCommandExactPulseTableBody = document.querySelector('#rflink-item-command-exact-pulse tbody');
                    const rflinkItemStateExactPulseTableBody = document.querySelector('#rflink-item-state-exact-pulse tbody');
                    const rflinkItemStateShiftPulseTableBody = document.querySelector('#rflink-item-state-shift-pulse tbody');
                    const rflinkExactPulseCheckbox = document.getElementById("rflink-item-state-use-exact-pulse");
                    const rflinkShiftWindowCheckbox = document.getElementById("rflink_item_use_shift_window");
                    const rflinkShiftWindowSizeTextbox = document.getElementById("rflink_shift_window_size");
                    const rflinkMaxCommonSubstringCheckbox = document.getElementById("use_rflink_max_common_substring");
                    const rflinkMaxCommonSubstringTextbox = document.getElementById("rflink_max_common_substring");
                    const pulseMiddleTextbox = document.getElementById("rflink_pulse_middle");
                    const modalTestResultsDiv = document.getElementById("modalTestResults");
                    const testResultsTextarea = document.getElementById("rflink_test_results");
                    const modalTestResultsCloseSpan = document.querySelector("#modalTestResults span.close"); 
                    const rflinkItemStateDiv = document.getElementById("rflink-item-state");
                    const rflinkItemCommandDiv = document.getElementById("rflink-item-command");
                    const rflinkPulseAddShiftBtn = document.getElementById("rflink_pulse_add_shift_btn");
                    const rflinkPulseMiddleControls = document.getElementById("rflink_pulse_middle_controls");

                    modalTestResultsCloseSpan.onclick = function(){
                        modalTestResultsDiv.style.display = "none";
                    }

                    // When the user clicks anywhere outside of the modal, close it
                    window.onclick = function(event) {
                        if (event.target == modalTestResultsDiv) {
                            modalTestResultsDiv.style.display = "none";
                        }
                    }

                    function testRFLink()
                    {
                        const data = document.getElementById("rflink_messages").value;
                        if(data.trim().length == 0)
                        {
                            return;
                        }

                        // Make an HTTP GET request using fetch
                        fetch('/rflink_item/test', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json' // Specify the content type as JSON
                            },
                            body: JSON.stringify({ data: data }) // Convert the data to JSON format
                        })
                        .then(response => {
                            // Check if the response is OK (status code 200)
                            if (!response.ok) {
                            throw new Error('Network response was not ok');
                            }
                            // Parse the JSON response
                            return response.json();
                        })
                        .then(data => {
                            // Handle the JSON data
                            console.log(data);
                            modalTestResultsDiv.style.display = "block";
                            testResultsTextarea.value = JSON.stringify(data, null, 2);
                        })
                        .catch(error => {
                            // Handle errors
                            console.error('There was a problem with the fetch operation:', error);
                        });
                    }

                    function getItemIdStateId(showAlert=true, throwException=true)
                    {
                        let item_state = document.getElementById("rflink_item_state_select").value;
                        console.log("item_state: ", item_state);
                        if(item_state == null || item_state == undefined || item_state.length == 0)
                        {
                            if(showAlert)
                            {
                                console.log("showing alert");
                                alert("Select an item command/state.");
                            }
                            if(throwException)
                            {
                                console.log("throwing exception");
                                throw "Select an item command/state.";
                            }
                        }

                        var [item_id, state_id, type] = item_state.split(",");
                        return {item_id: Number(item_id), state_id: Number(state_id), type: type};
                    }

                    pulseMiddleTextbox.onchange = function()
                    {
                        const pulseMiddle = Number(pulseMiddleTextbox.value);
                        let itemIdStateId = getItemIdStateId();

                        fetch('/rflink_item/' + itemIdStateId.item_id + '/state/' + itemIdStateId.state_id + '/pulse-middle', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json' // Specify the content type as JSON
                            },
                            body: JSON.stringify({pulseMiddle: pulseMiddle})
                        })
                        .then(response => {
                            // Check if the response is OK (status code 200)
                            if (!response.ok) {
                            throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                    }

                    rflinkShiftWindowSizeTextbox.onchange = function()
                    {
                        const windowSize = Number(rflinkShiftWindowSizeTextbox.value);
                        let itemIdStateId = getItemIdStateId();

                        fetch('/rflink_item/' + itemIdStateId.item_id + '/state/' + itemIdStateId.state_id + '/shift-window-size/' + windowSize, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json' // Specify the content type as JSON
                            }
                        })
                        .then(response => {
                            // Check if the response is OK (status code 200)
                            if (!response.ok) {
                            throw new Error('Network response was not ok');
                            }
                            rflink_items[itemIdStateId.item_id].states[itemIdStateId.state_id].shift_window_size = windowSize;
                            return response.json();
                        })
                    }

                    rflinkExactPulseCheckbox.onchange = function()
                    {
                        const use = rflinkExactPulseCheckbox.checked ? 1 : 0;
                        let itemIdStateId = getItemIdStateId();

                        fetch('/rflink_item/' + itemIdStateId.item_id + '/state/' + itemIdStateId.state_id + '/use-exact-pulse/' + use, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json' // Specify the content type as JSON
                            }
                        })
                        .then(response => {
                            // Check if the response is OK (status code 200)
                            if (!response.ok) {
                            throw new Error('Network response was not ok');
                            }
                            rflink_items[itemIdStateId.item_id].states[itemIdStateId.state_id].use_exact_pulse = use;
                            return response.json();
                        })
                    }

                    rflinkShiftWindowCheckbox.onchange = function()
                    {
                        const use = rflinkShiftWindowCheckbox.checked ? 1 : 0;
                        let itemIdStateId = getItemIdStateId();

                        fetch('/rflink_item/' + itemIdStateId.item_id + '/state/' + itemIdStateId.state_id + '/use-shift-window/' + use, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json' // Specify the content type as JSON
                            }
                        })
                        .then(response => {
                            // Check if the response is OK (status code 200)
                            if (!response.ok) {
                            throw new Error('Network response was not ok');
                            }
                            rflink_items[itemIdStateId.item_id].states[itemIdStateId.state_id].use_shift_window = use;
                            return response.json();
                        })
                    }

                    rflinkMaxCommonSubstringCheckbox.onchange = function()
                    {
                        const use = rflinkMaxCommonSubstringCheckbox.checked ? 1 : 0;
                        let itemIdStateId = getItemIdStateId();

                        fetch('/rflink_item/' + itemIdStateId.item_id + '/state/' + itemIdStateId.state_id + '/use-max-common-substring/' + use, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json' // Specify the content type as JSON
                            }
                        })
                        .then(response => {
                            // Check if the response is OK (status code 200)
                            if (!response.ok) {
                            throw new Error('Network response was not ok');
                            }
                            rflink_items[itemIdStateId.item_id].states[itemIdStateId.state_id].use_max_common_substring = use;
                            return response.json();
                        })
                    }

                    function rflinkDeleteStateExactPulse(item_id, state_id, pulse_sequence_id, type){
                        // Make an HTTP GET request using fetch
                        fetch('/rflink_item/' + Number(item_id) + '/' + type + '/' + Number(state_id) + '/delete-exact/'+pulse_sequence_id, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json' // Specify the content type as JSON
                            }
                        })
                        .then(response => {
                            // Check if the response is OK (status code 200)
                            if (!response.ok) {
                            throw new Error('Network response was not ok');
                            }
                            // Parse the JSON response
                            return response.json();
                        })
                        .then(data => {
                            // Handle the JSON data
                            if(type == "command")
                            {
                                console.log("setting rflink_items["+item_id+"].commands["+state_id+"].pulses_exact", rflink_items[Number(item_id)].commands[Number(state_id)].pulses_exact);
                                rflink_items[Number(item_id)].commands[Number(state_id)].pulses_exact = data;
                                populateCommandPulsesExactTable(item_id + "," + state_id);

                            }
                            else if(type == "state")
                            {
                                console.log("setting rflink_items["+item_id+"].states["+state_id+"].pulses_exact", rflink_items[Number(item_id)].states[Number(state_id)].pulses_exact);
                                rflink_items[Number(item_id)].states[Number(state_id)].pulses_exact = data;
                                populateStatePulsesExactTable(item_id + "," + state_id);
                            }
                        })
                        .catch(error => {
                            // Handle errors
                            console.error('There was a problem with the fetch operation:', error);
                        });
                    }

                    function rflinkDeleteShiftPulse(item_id, state_id, pulse_sequence_id){
                        // Make an HTTP GET request using fetch
                        fetch('/rflink_item/' + Number(item_id) + '/state/' + Number(state_id) + '/delete-shift/'+pulse_sequence_id, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json' // Specify the content type as JSON
                            }
                        })
                        .then(response => {
                            // Check if the response is OK (status code 200)
                            if (!response.ok) {
                            throw new Error('Network response was not ok');
                            }
                            // Parse the JSON response
                            return response.json();
                        })
                        .then(data => {
                            // Handle the JSON data
                            rflink_items[Number(item_id)].states[Number(state_id)].pulses_shift = data.pulses_shift;
                            populatePulsesShiftTable(item_id + "," + state_id);
                            rflinkMaxCommonSubstringTextbox.value = data.max_common_substring;
                        })
                        .catch(error => {
                            // Handle errors
                            console.error('There was a problem with the fetch operation:', error);
                        });
                    }
        
                    function rflinkAddExactPulse()
                    {
                        const data = document.getElementById("rflink_messages").value;
                        if(data.trim().length == 0)
                        {
                            return;
                        }
                        let pulseMiddle = -1
                        if(data.indexOf("Pulses(uSec)=") >= 0)
                        {
                            // there are raw pulses which must be converted to 1s and 0s, need a pulse middle
                            pulseMiddle = pulseMiddleTextbox.value;
                            if(pulseMiddle.trim() == 0)
                            {
                                alert("Data contains pulses, must supply a pulse middle value for conversion to 1s and 0s");
                                return;
                            }
                        }

                        let item_id = null;
                        let state_id = null;
                        let type = null;
                        try{
                            var ids = getItemIdStateId(false);
                            item_id = ids.item_id;
                            state_id = ids.state_id;
                            type = ids.type;
                        }
                        catch(error)
                        {
                            alert("Select an item command/state. Error:", error);
                            return;
                        }
                        
                        // Make an HTTP GET request using fetch
                        fetch('/rflink_item/' + Number(item_id) + '/' + type + '/' + Number(state_id) + '/add-exact', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json' // Specify the content type as JSON
                            },
                            body: JSON.stringify({ pulseMiddle: pulseMiddle, data: data }) // Convert the data to JSON format
                        })
                        .then(response => {
                            // Check if the response is OK (status code 200)
                            if (!response.ok) {
                            throw new Error('Network response was not ok');
                            }
                            // Parse the JSON response
                            return response.json();
                        })
                        .then(data => {
                            // Handle the JSON data
                            // console.log(data);
                            if(type == "command")
                            {
                                console.log("setting rflink_items["+item_id+"].commands["+state_id+"].pulses_exact", rflink_items[Number(item_id)].commands[Number(state_id)].pulses_exact);
                                rflink_items[Number(item_id)].commands[Number(state_id)].pulses_exact = data;
                                populateCommandPulsesExactTable(item_id + "," + state_id);
                            }
                            else if(type == "state")
                            {
                                console.log("setting rflink_items["+item_id+"].states["+state_id+"].pulses_exact", rflink_items[Number(item_id)].states[Number(state_id)].pulses_exact);
                                rflink_items[Number(item_id)].states[Number(state_id)].pulses_exact = data;
                                populateStatePulsesExactTable(item_id + "," + state_id);
                            }
                        })
                        .catch(error => {
                            // Handle errors
                            console.error('There was a problem with the fetch operation:', error);
                        });

                    }

                    function rflinkAddShiftPulse()
                    {
                        const data = document.getElementById("rflink_messages").value;
                        if(data.trim().length == 0)
                        {
                            return;
                        }
                        let pulseMiddle = -1
                        if(data.indexOf("Pulses(uSec)=") >= 0)
                        {
                            // there are raw pulses which must be converted to 1s and 0s, need a pulse middle
                            pulseMiddle = document.getElementById("rflink_pulse_middle").value;
                            if(pulseMiddle.trim() == 0)
                            {
                                alert("Data contains pulses, must supply a pulse middle value for conversion to 1s and 0s");
                                return;
                            }
                        }

                        let item_state = document.getElementById("rflink_item_state_select").value;
                        if(item_state == null || item_state == undefined || item_state.length == 0)
                        {
                            alert("Select an item command/state.");
                            return;
                        }

                        const postData = { pulseMiddle: pulseMiddle, data: data };
                        var [item_id, state_id] = item_state.split(",");
                        console.log("posting: " + JSON.stringify(postData));
                        
                        // Make an HTTP GET request using fetch
                        fetch('/rflink_item/' + Number(item_id) + '/state/' + Number(state_id) + '/add-shift', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json' // Specify the content type as JSON
                            },
                            body: JSON.stringify({ pulseMiddle: pulseMiddle, data: data }) // Convert the data to JSON format
                        })
                        .then(response => {
                            // Check if the response is OK (status code 200)
                            if (!response.ok) {
                            throw new Error('Network response was not ok');
                            }
                            // Parse the JSON response
                            return response.json();
                        })
                        .then(data => {
                            // Handle the JSON data
                            // console.log(data);
                            console.log("setting rflink_items["+item_id+"].states["+state_id+"].pulses_shift", rflink_items[Number(item_id)].states[Number(state_id)].pulses_shift);
                            rflink_items[Number(item_id)].states[Number(state_id)].pulses_shift = data.pulses_shift;
                            populatePulsesShiftTable(item_id + "," + state_id);
                            rflinkMaxCommonSubstringTextbox.value = data.max_common_substring;
                        })
                        .catch(error => {
                            // Handle errors
                            console.error('There was a problem with the fetch operation:', error);
                        });
                    }

                    function populateRFLinkPulsesControls(optionValue) {
                        let ids = getItemIdStateId();
                        
                        if(ids.type == "command")
                        {
                            rflinkItemStateDiv.style.display = "none";
                            rflinkPulseMiddleControls.style.display = "none";
                            rflinkPulseAddShiftBtn.style.display = "none";
                            rflinkItemCommandDiv.style.display = "block";
                            populateCommandPulsesExactTable(optionValue);
                        }
                        else if(ids.type == "state")
                        {
                            rflinkItemStateDiv.style.display = "block";
                            rflinkPulseMiddleControls.style.display = "";
                            rflinkPulseAddShiftBtn.style.display = "inline";
                            rflinkItemCommandDiv.style.display = "none";
                            rflinkExactPulseCheckbox.checked = rflink_items[ids.item_id].states[ids.state_id].use_exact_pulse;
                            rflinkShiftWindowCheckbox.checked = rflink_items[ids.item_id].states[ids.state_id].use_shift_window;
                            rflinkMaxCommonSubstringCheckbox.checked = rflink_items[ids.item_id].states[ids.state_id].use_max_common_substring;
                            rflinkShiftWindowSizeTextbox.value = rflink_items[ids.item_id].states[ids.state_id].shift_window_size;
                            rflinkMaxCommonSubstringTextbox.value = rflink_items[ids.item_id].states[ids.state_id].max_common_substring;
                            pulseMiddleTextbox.value = rflink_items[ids.item_id].states[ids.state_id].pulse_middle;
                            populateStatePulsesExactTable(optionValue);
                            populatePulsesShiftTable(optionValue);
                        }                        
                    }                    

                    function populateCommandPulsesExactTable(optionValue) {
                        rflinkItemCommandExactPulseTableBody.innerHTML = ''; // Clear existing rows
                        const parts = optionValue.split(",");
                        const item_id = Number(parts[0]);
                        const command_id = Number(parts[1]);
                        console.log("item_id: " + item_id + ", command_id: " + command_id);

                        // Populate table with data
                        rflink_items[item_id].commands[command_id].pulses_exact.forEach((p,i) => {
                            const row = document.createElement('tr');
                            const cellCount = document.createElement('td');
                            cellCount.textContent = p.length;
                            row.appendChild(cellCount);
                            const cellSequence = document.createElement('td');
                            cellSequence.textContent = p;
                            cellSequence.className = "sequence";
                            row.appendChild(cellSequence);
                            const cellActions = document.createElement('td');
                            var deleteBtn = document.createElement('button');
                            deleteBtn.textContent = "Delete";
                            deleteBtn.addEventListener('click', function(){
                                rflinkDeleteStateExactPulse(item_id, command_id, i, "command");
                            });
                            cellActions.appendChild(deleteBtn);
                            row.appendChild(cellActions);
                            rflinkItemCommandExactPulseTableBody.appendChild(row);
                        });
                    }

                    function populateStatePulsesExactTable(optionValue) {
                        rflinkItemStateExactPulseTableBody.innerHTML = ''; // Clear existing rows
                        const parts = optionValue.split(",");
                        const item_id = Number(parts[0]);
                        const state_id = Number(parts[1]);
                        // console.log("item_id: " + item_id + ", state_id: " + state_id);

                        // Populate table with data
                        rflink_items[item_id].states[state_id].pulses_exact.forEach((p,i) => {
                            const row = document.createElement('tr');
                            const cellCount = document.createElement('td');
                            cellCount.textContent = p.length;
                            row.appendChild(cellCount);
                            const cellSequence = document.createElement('td');
                            cellSequence.textContent = p;
                            cellSequence.className = "sequence";
                            row.appendChild(cellSequence);
                            const cellActions = document.createElement('td');
                            var deleteBtn = document.createElement('button');
                            deleteBtn.textContent = "Delete";
                            deleteBtn.addEventListener('click', function(){
                                rflinkDeleteStateExactPulse(item_id, state_id, i, "state");
                            });
                            cellActions.appendChild(deleteBtn);
                            row.appendChild(cellActions);
                            rflinkItemStateExactPulseTableBody.appendChild(row);
                        });
                    }

                    function populatePulsesShiftTable(optionValue) {
                        rflinkItemStateShiftPulseTableBody.innerHTML = ''; // Clear existing rows
                        const parts = optionValue.split(",");
                        const item_id = Number(parts[0]);
                        const state_id = Number(parts[1]);
                        // console.log("item_id: " + item_id + ", state_id: " + state_id);

                        // Populate table with data
                        rflink_items[item_id].states[state_id].pulses_shift.forEach((p,i) => {
                            const row = document.createElement('tr');
                            const cellCount = document.createElement('td');
                            cellCount.textContent = p.length;
                            row.appendChild(cellCount);
                            const cellSequence = document.createElement('td');
                            cellSequence.textContent = p;
                            cellSequence.className = "sequence";
                            row.appendChild(cellSequence);
                            const cellActions = document.createElement('td');
                            var deleteBtn = document.createElement('button');
                            deleteBtn.textContent = "Delete";
                            deleteBtn.addEventListener('click', function(){
                                rflinkDeleteShiftPulse(item_id, state_id, i);
                            });
                            cellActions.appendChild(deleteBtn);
                            row.appendChild(cellActions);
                            rflinkItemStateShiftPulseTableBody.appendChild(row);
                        });
                    }

                    rflinkItemSelect.addEventListener('change', function() {populateRFLinkPulsesControls(this.value);});
                    // initially populate tables with the first command/state pulses of the first rflink item
                    // because it is displayed first in the select element
                    if( rflink_items.length > 0)
                    {
                        populateRFLinkPulsesControls("0,0");  
                    }

                    var sse_connected = false;
                    var eventSource = new EventSource('/rflink/sse');
                    // Event listener for successful connection
                    eventSource.onopen = function() {
                        console.log("Connection established.");
                    };

                    // Event listener for closing the connection
                    eventSource.onclose = function() {
                        console.log("Connection closed.");
                    };

                    eventSource.onmessage = function(event) {
                        if(sse_connected)
                        {
                            rflink_messages.value += event.data +"\n";
                        }
                    };
            
                    eventSource.onerror = function(event) {
                        console.error('EventSource failed:', event);
                        eventSource.close();
                    };

                    document.getElementById("activateRFLink").addEventListener("click", function activateRFLink()
                    {
                        var form = document.getElementById("rfLinkConnectForm");
                        form.action = document.getElementById("activateRFLink").checked ? "/rflink/activate" : "/rflink/deactivate";
                        form.submit(); // Submit the form
                    });
                    
                    document.getElementById("debugRFLink").addEventListener("click", function debugRFLink()
                    {
                        var form = document.getElementById("rfLinkConnectForm");
                        form.action = document.getElementById("debugRFLink").checked ? "/rflink/debug/1" : "/rflink/debug/0";
                        form.submit(); // Submit the form
                    });

                    function connectRFLink() {
                        sse_connected = true;
                        // Hide Connect button
                        document.getElementById("rflinkConnectBtn").style.display = "none";
                        // Show Disconnect button
                        document.getElementById("rflinkDisconnectBtn").style.display = "inline-block";
                    }

                    function disconnectRFLink() {
                        sse_connected = false;
                        // Hide Disconnect button
                        document.getElementById("rflinkDisconnectBtn").style.display = "none";
                        // Show Connect button
                        document.getElementById("rflinkConnectBtn").style.display = "inline-block";
                    }

                    function clearRFLinkTextarea() {
                        document.getElementById("rflink_messages").value = ""; // Clear textarea
                    }
                </script>
        </div>
    </div>

    <script>        
        function toggleContent(elementId, show) {
            var content = document.getElementById(elementId);
            if (show) {
                content.style.display = 'block';
            } else {
                content.style.display = 'none';
            }
        }
    </script>
</body>
</html>